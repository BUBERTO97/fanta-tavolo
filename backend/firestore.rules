rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Collezione Utenti ---
    // Contiene i ruoli (es. 'admin')
    match /users/{userId} {
      // Solo l'utente proprietario può leggere i propri dati
      allow read: if request.auth != null && request.auth.uid == userId;
      // La scrittura dei ruoli è bloccata dall'app per sicurezza
      allow write: if false;
    }

    // --- Collezione Invitati ---
    match /invitati/{docId} {
      // Tutti gli utenti autenticati possono leggere la lista
      allow read: if request.auth != null;
      // Solo gli amministratori possono scrivere
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Collezione Pronostici ---
    match /pronostici/{userId} {
      // Tutti gli utenti autenticati possono leggere i pronostici
      allow read: if request.auth != null;

      // La scrittura è permessa a due condizioni:
      // 1. Un utente normale può scrivere sul PROPRIO pronostico SOLO SE le previsioni sono sbloccate.
      // 2. Un amministratore può scrivere su QUALSIASI pronostico (es. per confermare il voto).
      allow write: if request.auth != null &&
                   ((request.auth.uid == userId && get(/databases/$(database)/documents/settings/game).data.predictionsLocked == false) ||
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // --- Collezione Impostazioni ---
    match /settings/{docId} {
      // Tutti gli utenti autenticati possono leggere le impostazioni
      allow read: if request.auth != null;
      // Solo gli amministratori possono modificare le impostazioni
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Collezione Risultati ---
    match /risultati/{docId} {
      // Tutti gli utenti autenticati possono leggere i risultati finali
      allow read: if request.auth != null;
      // Solo gli amministratori possono scrivere i risultati
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Collezione Classifica ---
    match /leaderboard/{docId} {
      // Tutti gli utenti autenticati possono leggere la classifica
      allow read: if request.auth != null;
      // Solo gli amministratori possono scrivere la classifica
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}